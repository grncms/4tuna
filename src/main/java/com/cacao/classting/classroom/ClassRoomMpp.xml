<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cacao.classting.classroom.ClassRoomMpp">

	<resultMap id="resultMapObj" type="com.cacao.classting.classroom.ClassRoom"></resultMap>
	<sql id="selectCommonClass">
		FROM
		ctClass
		WHERE 1=1
		<choose>
			<when test="shCtcsDelNy ==1">AND ctcsDelNy = 1</when>
			<when test="shCtcsDelNy ==2">AND ctcsDelNy = 0</when>
		</choose>
		<if test="shCtcsName != null and !shCtcsName.equals('')"> AND ctcsName LIKE concat('%',#{shCtcsName},'%')</if>
		<choose>
			<when test="shOption ==1">AND ctcsName LIKE concat('%',#{shValue},'%')</when>
			<when test="shOption ==2">AND ctcsBelongto LIKE concat('%',#{shValue},'%')
			</when>
		</choose>
		<choose>
			<when test="shOptionDate == 1">AND regDateTime BETWEEN #{shDateStart} AND
				#{shDateEnd}</when>
			<when test="shOptionDate == 2">AND modDateTime BETWEEN #{shDateStart} AND
				#{shDateEnd}</when>
		</choose>

	</sql>
	<select id="selectOneMemberClass" resultMap="resultMapObj">
		select
		ctcmName
		from
		ctClassMember

		where 1=1
		and ctcmSeq = #{ctcmSeq}
	</select>
	<select id="selectOneCount" resultType="Integer">
		SELECT
		count(*)
		<include refid="selectCommonClass" />
	</select>

	<update id="updateClass">
		UPDATE
		ctClassMember
		SET
		ctcmName = #{ctcmName}
		,ctcmAlarmReplyNy = #{ctcmAlarmReplyNy}
		,ctcmAlarmReactionNy = #{ctcmAlarmReactionNy}

		WHERE 1=1
		AND ctcmSeq = #{ctcmSeq}

	</update>
	<delete id="deleteMemberForcely">
		DELETE FROM
		ctClassMember
		WHERE 1=1
		AND ctcmSeq = #{ctcmSeq}
	</delete>

	<select id="selectListClass" resultMap="resultMapObj">
		SELECT
		ctcsSeq
		,ctcsName
		,ctcsBelongto
		,ctcsCode
		,regDateTime
		,ctcsDelNy
		<include refid="selectCommonClass" />
		limit #{startRnumForMysql},#{rowNumToShow}

	</select>


	<select id="selectOneClass" resultMap="resultMapObj">
		select
		a.ctcsSeq
		,a.ctcsName
		,a.ctcsBelongto
		,a.ctcsDesc
		,a.regDateTime
		,a.ctcsCode

		from
		ctClass a

		where 1=1
		AND a.ctcsSeq = #{ctcsSeq}

	</select>

	<update id="deleteClass">
		UPDATE
		ctClass
		SET
		ctcsDelny = 1
		WHERE 1=1
		AND ctcsSeq = #{ctcsSeq}
	</update>
	<update id="deleteClassMulti">
		UPDATE
		ctClass
		SET
		ctcsDelny = 1
		WHERE 1=1
		AND ctcsSeq = #{ctcsSeq}
	</update>

	<!-- 클래스내 정보 불러오기! -->
	<select id="selectOneSidebar" resultMap="resultMapObj">
		SELECT
		a.ctcsSeq
		,a.ctcsYear
		,a.ctcsName
		,b.ctcmSeq
		,b.ctcmName
		,b.ctcmTeacherNy
		FROM
		ctClass a
		LEFT JOIN ctClassMember b on b.ctcsSeq = a.ctcsSeq
		WHERE 1=1
		AND b.ctcsSeq = #{ctcsSeq}
		AND b.mmSeq = #{mmSeq}
	</select>
	<!-- 구성원 초대하기 -->
	<select id="selectOneClassInfo" resultMap="resultMapObj">
		select
		ctcsCode
		,ctcsName
		from
		ctClass
		where 1=1
		and ctcsSeq = #{ctcsSeq}
	</select>
	<!-- 게시물 리스트 -->
	<select id="selectListPost" resultMap="resultMapObj">
		SELECT
			a.ctptSeq
			,a.ctptTitle
			,a.ctptWriter
			,a.ctptContent
			,a.regDateTime
			,a.ctptLike1
			,a.ctptLike2
			,a.ctptLike3
			,a.ctptView
			,a.ctptReservationNy
			,b.ctboTypeCd
		FROM
			ctPost a
		LEFT JOIN ctBoard b on b.ctboSeq = a.ctboSeq
		WHERE 1=1
			AND b.ctcsSeq = #{ctcsSeq}
			AND a.ctptReservationNy = 0
		ORDER BY a.regDateTime
	</select>
	<!-- 게시물 보기 -->
	<select id="selectOneClassPost" resultMap="resultMapObj">
		select
		ctptSeq
		,ctptTitle
		,ctptWriter
		,ctptContent
		,regDateTime
		,ctptLike1
		,ctptLike2
		,ctptLike3
		,ctboSeq
		,ctptView
		from
		ctPost
		where 1=1
		and ctptSeq = #{ctptSeq}
	</select>
	<!-- 게시글 등록 -->
	<insert id="insertPost">
		insert into ctPost(
		ctptSeq
		,ctptTitle
		,ctptWriter
		,ctptContent
		,regDateTime
		,ctptReservationNy
		,ctptReservation
		,ctboSeq
		,ctptDelNy
		) VALUES (
		#{ctptSeq}
		,#{ctptTitle}
		,#{ctptWriter}
		,#{ctptContent}
		,now()
		,#{ctptReservationNy}
		,#{ctptReservation}
		,#{ctboSeq}
		,0
		)
	</insert>


	<!-- 게시글 수정 -->
	<update id="updatePost">
		update ctPost (
		ctptTitle
		,ctptWriter
		,ctptContent
		,ctboSeq
		,ctptDelNy
		) VALUES (
		,#{ctptTitle}
		,#{ctptWriter}
		,#{ctptContent}
		,#{ctboSeq}
		,0
		)
	</update>



	<!-- 과제 리스트 -->
	<select id="selectListHomework" resultMap="resultMapObj">
		SELECT
		a.cthpSeq
		,a.cthpTitle
		,a.cthpWriter
		,a.cthpDesc
		,a.cthpData
		,a.cthpEndDateTime
		,a.cthpUseNy
		,a.cthpDelNy
		,a.regDateTime
		,b.ctcsSeq
		FROM
		ctHomeworkPost a
		LEFT JOIN ctClass b on b.ctcsSeq = a.ctcsSeq
		WHERE 1=1
		AND b.ctcsSeq = #{ctcsSeq}
		ORDER BY a.regDateTime DESC
	</select>

	<!-- 과제 보기 -->
	<select id="selectOneClassHomework" resultMap="resultMapObj">
		select
		cthpSeq
		,cthpTitle
		,cthpWriter
		,cthpDesc
		,cthpData
		,cthpEndDateTime
		,cthpUseNy
		,cthpDelNy
		,regDateTime
		,ctcsSeq
		from
		ctHomeworkPost
		where 1=1
		and ctcsSeq = #{ctcsSeq}
		and cthpSeq = #{cthpSeq}
	</select>

	<!-- 과제제출 리스트 -->
	<select id="selectListHomeworkSubmit" resultMap="resultMapObj">
		SELECT
		a.cthsSeq
		,a.cthsTitle
		,a.cthsWriter
		,a.cthsDesc
		,a.cthsData
		,a.cthsScore
		,a.cthsUseNy
		,a.cthsDelNy
		,a.cthpSeq
		,a.regDateTime
		,b.ctcsSeq
		FROM
		ctHomeworkSubmit a
		LEFT JOIN ctHomeworkPost b on b.cthpSeq = a.cthpSeq
		WHERE 1=1
		AND a.cthpSeq = #{cthpSeq}
		AND b.ctcsSeq = #{ctcsSeq}
	</select>

	<!-- 학생이 제출한 과제 -->
	<select id="homeworkSubmit" resultMap="resultMapObj">
		SELECT cthpSeq, cthsSeq,
		ctcmName,cthsWriter,cthsScore
		FROM ctHomeworkSubmit a
		LEFT JOIN
		ctClassMember b on a.cthsWriter = b.ctcmseq
		WHERE ctcsSeq = #{ctcsSeq}
		<!-- and cthsWriter = #{cthsWriter} -->
	</select>

	<select id="homeworkWriter" resultMap="resultMapObj">
		SELECT distinct
		a.cthsWriter , c.ctcmName
		FROM classing.ctHomeworkSubmit a
		left join
		ctHomeworkPost b on a.cthpSeq = b.cthpSeq
		left join ctClassMember c on
		a.cthsWriter = c.ctcmSeq
		where b.ctcsSeq = ${ctcsSeq};
	</select>
	<!-- 과제제출(학생) -->
	<insert id="insertHomeworkSubmit">
		insert into ctHomeworkSubmit(
		cthsTitle
		,cthsDesc
		,cthsData
		,cthsWriter
		,cthsScore
		,cthsUseNy
		,cthsDelNy
		,regDateTime
		,modDateTime
		,cthpSeq
		) VALUES (
		#{cthsTitle}
		,#{cthsDesc}
		,#{cthsData}
		,#{cthsWriter}
		,#{cthsScore}
		,1
		,0
		,#{regDateTime}
		,#{modDateTime}
		,#{cthpSeq}
		<selectKey resultType="String" keyProperty="cthsSeq"
			order="AFTER">
			SELECT last_insert_id()
		</selectKey>
		)
	</insert>
	<!-- 과제등록(선생님) -->
	<insert id="insertHomeworkPost">
		insert into ctHomeworkPost(
		cthpTitle
		,cthpDesc
		,cthpData
		,cthpWriter
		,cthpEndDateTime
		,cthpUseNy
		,cthpDelNy
		,regDateTime
		,modDateTime
		,ctcsSeq
		) VALUES (
		#{cthpTitle}
		,#{cthpDesc}
		,#{cthpData}
		,#{cthpWriter}
		<!-- <choose> <when test="cthpEndDateTime.equals('')">,NULL</when> <otherwise>,#{cthpEndDateTime}</otherwise> 
			</choose> -->
		,#{cthpEndDateTime}
		,1
		,0
		,#{regDateTime}
		,#{modDateTime}
		,#{ctcsSeq}
		)
		<selectKey resultType="String" keyProperty="cthpSeq"
			order="AFTER">
			SELECT last_insert_id()
		</selectKey>
	</insert>
	<!-- 과제 점수 update -->
	<update id="updateHomeworkSubmitScore">
		UPDATE
		ctHomeworkSubmit
		SET
		cthsScore = #{cthsScore}
		WHERE 1=1
		AND cthpSeq = #{cthpSeq}
		AND cthsSeq = #{cthsSeq}
	</update>
	
	<!-- 과제제출 보기(선생님->학생것) -->
	<select id="selectOneHomeworkSubmit" resultMap="resultMapObj">
		select
		cthsSeq
		,cthsTitle
		,cthsWriter
		,cthsDesc
		,cthsData
		,cthsScore
		,cthsUseNy
		,cthsDelNy
		,regDateTime
		,cthpSeq
		from
		ctHomeworkSubmit
		where 1=1
		and cthpSeq = #{cthpSeq}
	</select>
	<!-- 과제제출 보기(학생->본인것) -->
	<select id="selectOneHomeworkSubmitStudent" resultMap="resultMapObj">
		select
			cthsSeq
			,cthsTitle
			,cthsWriter
			,cthsDesc
			,cthsData
			,cthsScore
			,cthsUseNy
			,cthsDelNy
			,regDateTime
		from
			ctHomeworkSubmit
		where 1=1
			and cthpSeq = #{cthpSeq}
			and cthsWriter = #{cthsWriter}
	</select>
	<!-- 과제 제출물 수정 -->
	<update id="updateHomeworkSubmit">
		UPDATE
		ctHomeworkSubmit
		SET
		cthsTitle = #{cthsTitle}
		,cthsDesc = #{cthsDesc}
		WHERE 1=1
		AND cthsSeq = #{cthsSeq}
	</update>
	<!-- 구성원 리스트 -->
	<select id="selectListClassMember" resultMap="resultMapObj">
		SELECT
		a.ctcmSeq
		,a.ctcmName
		,a.ctcmTeacherNy
		,a.ctcsSeq
		FROM
		ctClassMember a
		WHERE 1=1
		AND a.ctcsSeq = #{ctcsSeq}
	</select>

	<!-- 전체 구성원 중 학생 -->
	<select id="selectOneMemberCount" resultType="Integer">
		SELECT
		count(*)
		FROM
		ctClassMember
		WHERE 1=1
		AND ctcsSeq = #{ctcsSeq}
		AND ctcmTeacherNy = 0
	</select>
	<!-- 과제 제출자 수 -->
	<select id="selectOneSubmitCount" resultType="Integer">
		SELECT
		count(*)
		FROM
		ctHomeworkSubmit
		WHERE 1=1
		AND cthpSeq = #{cthpSeq}
	</select>
	<select id="homeworkAvg" resultMap = "resultMapObj">
		
	</select>

	<!-- 예약/임시저장 리스트 --> <!-- 임시저장만 -->
	<select id="selectListStorage" resultMap="resultMapObj">
		SELECT
		a.ctptSeq
		,a.ctptTitle
		,a.ctptWriter
		,a.ctptReservation
		,a.ctptContent
		,a.ctptReservationNy
		,a.regDateTime
		,a.ctboSeq
		,b.ctboTypeCd
		FROM
		ctPost a
		LEFT JOIN ctBoard b on b.ctboSeq = a.ctboSeq
		LEFT JOIN
		ctClassMember c on c.ctcmSeq = a.ctptWriter
		WHERE 1=1
		AND a.ctptReservationNy = 1
		AND b.ctcsSeq = #{ctcsSeq}

	</select>

	<!-- 예약/임시저장 리스트 --><!-- 예약만 -->
	<select id="selectListReserv" resultMap="resultMapObj">
		SELECT
		a.ctptSeq
		,a.ctptTitle
		,a.ctptWriter
		,a.ctptReservation
		,a.ctptContent
		,a.ctptReservationNy
		,a.regDateTime
		,a.ctboSeq
		,b.ctboTypeCd
		FROM
		ctPost a
		LEFT JOIN ctBoard b on b.ctboSeq = a.ctboSeq
		LEFT JOIN
		ctClassMember c on c.ctcmSeq = a.ctptWriter
		WHERE 1=1
		AND a.ctptReservation > now()
		AND b.ctcsSeq = #{ctcsSeq}

	</select>



	<select id="selectOneClassPostUrl" resultMap="resultMapObj">
		select
		originalName
		from
		ctPostUploaded
		where 1=1
		and pseq = #{ctptSeq}
	</select>

	<!-- 동영상 등록 -->
	<insert id="insertUrl">
		insert into ctPostUploaded(
		seq
		,originalName
		,delNy
		,pseq
		) VALUES (
		#{seq}
		,#{originalName}
		,0
		,#{pseq}
		)
	</insert>

	<!-- 게시물 댓글 리스트 -->
	<select id="selectListReply" resultMap="resultMapObj">
		SELECT
		a.ctrpSeq
		,a.ctrpContent
		,a.ctrpWriter
		,a.ctrpDelNy
		,a.regDateTime
		,a.ctptSeq
		FROM
		ctReply a
		LEFT JOIN ctPost b on b.ctptSeq = a.ctptSeq
		WHERE 1=1
		AND a.ctptSeq = #{ctptSeq}
		AND a.ctrpDelNy = 0
	</select>
	<!-- 게시물 댓글 등록 -->
	<insert id="insertReply">
		insert into ctReply(
		ctrpSeq
		,ctrpContent
		,ctrpWriter
		,ctrpDelNy
		,regDateTime
		,ctptSeq
		) VALUES (
		#{ctrpSeq}
		,#{ctrpContent}
		,#{ctrpWriter}
		,0
		,now()
		,#{ctptSeq}
		)
	</insert>
	<!-- 게시물 댓글 삭제(update) -->
	<update id="updateReplyUele">
		UPDATE ctReply SET		
			ctrpDelNy = 1
		WHERE 1=1
			AND ctrpSeq = #{ctrpSeq}
	</update>

	<!-- 과제게시물 댓글 리스트 -->
	<select id="selectListHomeworkReply" resultMap="resultMapObj">
		SELECT
		a.ctrhSeq
		,a.ctrhContent
		,a.ctrhWriter
		,a.ctrhDelNy
		,a.regDateTime
		,a.cthpSeq
		FROM
		ctReplyHomework a
		LEFT JOIN ctHomeworkPost b on b.cthpSeq = a.cthpSeq
		WHERE 1=1
		AND a.cthpSeq = #{cthpSeq}
		AND a.ctrhDelNy = 0
	</select>
	
	<!-- 과제게시물 댓글 등록 -->
	<insert id="insertHomeworkReply">
		insert into ctReplyHomework(
		ctrhSeq
		,ctrhContent
		,ctrhWriter
		,ctrhDelNy
		,regDateTime
		,cthpSeq
		) VALUES (
		#{ctrhSeq}
		,#{ctrhContent}
		,#{ctrhWriter}
		,0
		,#{regDateTime}
		,#{cthpSeq}
		)
	</insert>
	
	<!-- 과제게시물 댓글 삭제(update) -->
	<update id="updateHomeworkReplyUele">
		UPDATE ctReplyHomework SET		
			ctrhDelNy = 1
		WHERE 1=1
			AND ctrhSeq = #{ctrhSeq}
	</update>	
	
	<!-- 과제제출물 댓글 리스트 -->
	<select id="selectListHomeworkSubmitReply" resultMap="resultMapObj">
		SELECT
		a.ctrsSeq
		,a.ctrsContent
		,a.ctrsWriter
		,a.ctrsDelNy
		,a.regDateTime
		,a.cthsSeq
		FROM
		ctReplyHomeworkSubmit a
		LEFT JOIN ctHomeworkSubmit b on b.cthsSeq = a.cthsSeq
		WHERE 1=1
		AND a.cthsSeq = #{cthsSeq}
		AND a.ctrsDelNy = 0
	</select>
	
	<!-- 과제제출물 댓글 등록 -->
	<insert id="insertHomeworkSubmitReply">
		insert into ctReplyHomeworkSubmit(
		ctrsSeq
		,ctrsContent
		,ctrsWriter
		,ctrsDelNy
		,regDateTime
		,cthsSeq
		) VALUES (
		#{ctrsSeq}
		,#{ctrsContent}
		,#{ctrsWriter}
		,0
		,#{regDateTime}
		,#{cthsSeq}
		)
	</insert>

	<!-- 과제게시물 댓글 삭제(update) -->
	<update id="updateHomeworkSubmitReplyUele">
		UPDATE ctReplyHomeworkSubmit SET		
			ctrsDelNy = 1
		WHERE 1=1
			AND ctrsSeq = #{ctrsSeq}
	</update>	

	<!-- 조회수 증가 -->
	<update id="hitUpdate">
		update ctPost
		set ctptView = ctptView + 1
		where ctptSeq = #{ctptSeq}
	</update>


	<!-- 클래스 설정 -->
	<update id="insertSetting">
		update ctClass (
		ctcsName
		,ctcsGradeCd
		,ctcsDesc

		) values (

		#{ctcsName}
		,#{ctcsGradeCd}
		,#{ctcsDesc}
		)

	</update>



	<!-- 출석부 -->

	<insert id="attendance">
		insert into ctAttendance (
		ctcmSeq,
		ctadRegDateTime
		) values (

		#{ctcmSeq},
		#{ctadRegDateTime}
		)
	</insert>

	<select id="getClassId" resultMap="resultMapObj">
		select ctcmSeq
		from ctClassMember
		where mmSeq = ${mmSeq} and ctcsSeq = ${ctcsSeq}
	</select>

	<!-- 출석부 날짜비교해서 하루에 한번만 기록 들어가게끔, 오늘 날짜로 들어간것들 다 불러오는 쿼리 -->
	<select id="today" resultType="int">
		select count(*)
		from ctAttendance
		where ctcmSeq=${ctcmSeq}
		and DATE_FORMAT(ctadRegDateTime, '%Y-%m-%d')=#{attendanceToday}
	</select>

	<select id="enterLog" resultMap="resultMapObj">
<![CDATA[
select ctcmName,ctadRegDateTime 
from ctClassMember a 
left join ctAttendance b on a.ctcmSeq = b.ctcmSeq 
where ctcsSeq = #{classSeq}
and b.ctadRegDateTime > #{startDate} and 
b.ctadRegDateTime < #{endDate}

]]>
	</select>
</mapper>